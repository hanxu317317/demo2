$(document).ready(function(){function t(){$.ajax({url:"tenant-gateway/account/invitations",type:"GET",headers:{Authorization:_},contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(t){k=t.body.items||[],e()}})}function n(){$.ajax({url:"tenant-gateway/account/relations",type:"GET",headers:{Authorization:_},contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(t){C=t.body.items||[],a()}})}function e(){var t=$(".invite-list__body");if(t.empty(),$(".invite-list__header-tip").hide(),0===k.length){var n=$("<ul></ul>").addClass("invite-list__empty"),e=$("<img>").attr("src","/public/img/gray-logo.svg"),i=$("<p></p>").text("友情提示：您的列表为空！");n.append(e).append(i),t.append(n)}else for(var a in k){var s=k[a],c=$("<ul></ul>"),r=$("<img>").attr("src","/public/img/logo.svg").addClass("invite-list__logo"),u=$("<div></div>").addClass("invite-list__content"),l=$("<div></div>").addClass("invite-list__button-group"),p=$("<p></p>").addClass("invite-list__name").text(s.org_name+" 邀请您加入!"),_=$("<p></p>").addClass("invite-list__time").text("有效期至： "+d(s.expired_at)),v=$("<button></button>").addClass("invite-list__deny invite-button__neutral").text("拒绝"),f=$("<button></button>").addClass("invite-list__accept invite-button__brand").text("同意"),g=$("<p></p>").addClass("invite-list__text-invalid");u.append(p).append(_),"init"!=s.status||s.expired?(p.addClass("invite-deny"),"accept"==s.status?l.append(g.text("已同意")):"deny"==s.status?l.append(g.text("已拒绝")):"cancel"==s.status?l.append(g.text("已取消")):s.expired&&l.append(g.text("已过期"))):(l.append(v).append(f),$(".invite-list__header-tip").show()),c.append(r).append(u).append(l),t.append(c),function(t){v.click(function(){o(t.id)}),f.click(function(){$(".invite-modal").fadeIn(300),y=t.id})}(s)}}function i(){$.ajax({url:"login/account/v1/sign_out",type:"POST",headers:{Authorization:_},contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(t){setCookie("_accountToken","",-1),setCookie("_accessToken","",-1),setCookie("_refreshToken","",-1),window.location.href="/signin"}})}function a(){var t=$(".company-list__body");t.empty();for(var n in C){var e=C[n],i=$("<ul></ul>"),a=$("<img>").attr("src","/public/img/logo.svg").addClass("company-list__logo"),o=$("<div></div>").addClass("company-list__content"),s=$("<div></div>").addClass("company-list__button-group"),r=$("<p></p>").addClass("company-list__name").text(e.org_name),d=$("<p></p>").addClass("company-list__button-enter").text("进入企业");s.append(d),o.append(r),i.append(a).append(o).append(s),t.append(i),function(t){d.click(function(){c(t)}),r.click(function(){c(t)}),a.click(function(){c(t)})}(e)}}function o(n){$.ajax({url:"tenant-gateway/account/deny_invitation/"+n,type:"POST",headers:{Authorization:_},contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(n){t()}})}function s(e){if(!u())return!1;if(!l())return!1;var i={email:$.trim(v.val()),name:$.trim(f.val())};$.ajax({url:"tenant-gateway/account/accept_invitation/"+e,type:"POST",headers:{Authorization:_},data:JSON.stringify(i),contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(e){v.val(),f.val(),$(".invite-modal").fadeOut(300),t(),n()}})}function c(t){var n=t.tenant_id;h=t.user_id;var e={source:"web",tenant_id:n};$.ajax({url:"tenant-gateway/account/signin",type:"POST",headers:{Authorization:_},data:JSON.stringify(e),contentType:"application/json; charset=UTF-8",error:function(t){p(t)},success:function(t){setCookie("_userId",h,6048e5),setCookie("_tenant_id",n,6048e5),r(n,h),setCookie("_orgname","meiqia",6048e5),setCookie("_accessToken",t.body.access_token,6048e5),setCookie("_refreshToken",t.body.refresh_token,6048e5),window.location.href="/"}})}function r(t,n){var e="_"+m,i={userId:n,tenantId:t};setCookie(e,JSON.stringify(i),6048e5)}function d(t){"string"==typeof t&&(t=parseInt(t));var n=new Date(1e3*t),e="";return e+=n.getFullYear()+"/",e+=n.getMonth()+1+"/",e+=n.getDate(),e+=" "+n.getHours()+":",n.getMinutes()<10?e+="0"+n.getMinutes():e+=n.getMinutes(),n.getHours()>12&&0!=n.getMinutes()?e+=" PM":e+=" AM",e}function u(){return!!/^[A-Za-z0-9\u4e00-\u9fa5]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(v.val())||(warning("请正确输入邮箱","#tellphone"),!1)}function l(){return""!==f.val()||(warning("名字不能为空","#name"),!1)}function p(t){var n=t.responseJSON.code;[106004,102202,106002].indexOf(n)>=0&&(setCookie("_accountToken","",-1),setCookie("_accessToken","",-1),setCookie("_refreshToken","",-1),window.location.href="./signin")}var _=decodeURIComponent(getCookie("_accountToken")),v=$("#email input"),f=$("#name input"),g=!1,y="",h="",m=getCookie("_currentPhone");v.blur(function(){u()}),f.blur(function(){l()}),$(".invite-list__header span").click(function(){g?($(this).find(".invite-list__header-line").removeClass("invite-list__header-line-open"),g=!1):($(this).find(".invite-list__header-line").addClass("invite-list__header-line-open"),g=!0),$(".invite-list__body").toggle()}),$(".invite-modal .invite-modal__close").click(function(){$(".invite-modal").fadeOut(300)}),$("#acceptBtn").click(function(){s(y)}),$("#signout").click(function(){i()});var k=[],C=[];t(),n()});